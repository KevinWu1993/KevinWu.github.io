<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="KevinWu的个人博客">
  <meta name="keyword" content="undefined">
  
    <link rel="icon" href="">
  
    
  <title>DIY一个智能插座 | KevinWu.CN</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css" />
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>KevinWu.CN</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>DIY一个智能插座</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2016年06月24日</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/酷玩/">酷玩</a>
  </div>



            
            
              | 
                  <i class="fa fa-tags" aria-hidden="true"></i>
                
               
  <a href="/tags/#智能" class='tag'>智能</a>

  <a href="/tags/#硬件" class='tag'>硬件</a>

  <a href="/tags/#手工" class='tag'>手工</a>

  <a href="/tags/#单片机" class='tag'>单片机</a>

  <a href="/tags/#DIY" class='tag'>DIY</a>

  <a href="/tags/#插座" class='tag'>插座</a>


            
          </div>
          <p>像网上随便搜都能搜到的各种物联网啊云啊的概念就不扯了，扯再多还不如自己动手接个线焊个锡写几行代码来的实在，所以这次没有背景知识，直入正题。</p>
<h2 id="材料准备"><a href="#材料准备" class="headerlink" title="材料准备"></a>材料准备</h2><table>
<thead>
<tr>
<th>材料</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>插线板（有人叫插座）</td>
<td>1</td>
</tr>
<tr>
<td>ESP8266wifi芯片</td>
<td>1 </td>
</tr>
<tr>
<td>AC-DC电源转换模块（220V～5V）</td>
<td>1</td>
</tr>
<tr>
<td>继电器</td>
<td>1</td>
</tr>
<tr>
<td>杜邦线</td>
<td>若干</td>
</tr>
<tr>
<td>USB转TTL小板</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>算上上面的东西，就算买个好点的插座，线粗点，也不用超过60块钱，比网上卖的智能插座便宜多了。<br><a id="more"></a></p>
<h3 id="硬件改造"><a href="#硬件改造" class="headerlink" title="硬件改造"></a>硬件改造</h3><p>这一步纯手工活，需要有点用电烙铁和电路的基础，但这一步也要特别细心，220V的电源，如果不小心没焊接牢固或者焊接错了，短路可不是什么好玩的事哇。</p>
<p>可以上些图看看这个过程和成品（成平丑的像个定时炸弹是因为没有热熔胶，某些固定工作临时临急用黑胶布代替，当然作为第一个实验品也没考虑买个大点的插座把那些芯片什么的都塞到里面去）：</p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/27477687.jpg" alt=""></p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/17273104.jpg" alt=""></p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/7623646.jpg" alt=""></p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/19241771.jpg" alt=""></p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/98569802.jpg" alt=""></p>
<h3 id="总结一下改造步骤"><a href="#总结一下改造步骤" class="headerlink" title="总结一下改造步骤"></a>总结一下改造步骤</h3><ol>
<li>拆解插线板</li>
<li>从插线板的火线和零线引出电源到AC-DC电源转换器，电源转换器引出线，并联连接ESP8266芯片及继电器，提供5V工作电源</li>
<li>用万用表测试继电器短路情况</li>
<li>继电器与插线板入口火线串联接入</li>
<li>继电器连接ESP8266的GPIO控制端口</li>
</ol>
<h2 id="本地局域网控制的智能插座"><a href="#本地局域网控制的智能插座" class="headerlink" title="本地局域网控制的智能插座"></a>本地局域网控制的智能插座</h2><p>可以先把这个的缺点讲一下，这是种仅仅做出来，但不实用的插座，这种插座只能通过手机控制端连接智能插座的wifi控制芯片来控制插座的开关，或者通过连接同一个无线路由器，通过设置转发的方式来控制。</p>
<blockquote>
<p>原理很简单，就是Socket通信。</p>
</blockquote>
<p>虽然原理很简单，而且我也不推荐这个方案，不过这个方案在我研究它的接口的时候却是最煎熬的，因为ESP8266的固件是已经编译好了的，单片机没文档，没固件源码也很难上手，所以想着用官方示例的控制APP来反编译把API找出来，然而像这类东西，大部分都是写单片机的程序员，安卓这边写的少，很多控制APP都是用易安卓搞出来的，反编译。。。不忍直视，最后只能抓包来找了。。。</p>
<p>因为官方没有接口文档，这也不是我主要推荐的方案，我就不补充文档了，如果需要仿照做的直接看我代码也能看出来。</p>
<p>直接开始撸代码。</p>
<p>当然，采用MVP框架来搭建的话，建模是少不了的，先建立灯光控制的模型（这个官方AT固件本来是控制三色灯的，只是我发现也能控制IO口）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">package</span> cn.kevinwu.esp8266_controller.model;</div><div class="line"></div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.dao.LightDAO;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line"> * Created by KevinWu on 16-5-29.</div><div class="line"></div><div class="line"> * KevinWu.cn</div><div class="line"></div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightModel</span> <span class="keyword">implements</span> <span class="title">IModel</span>&lt;<span class="title">LightModel</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> LightDAO dao;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> freq;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io0;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io1;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io2;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io4;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io5;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io12;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io13;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io14;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> io15;</div><div class="line">    <span class="keyword">private</span> RGBBean rgb;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightModel</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.dao=<span class="keyword">new</span> LightDAO();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightModel</span><span class="params">(<span class="keyword">int</span> freq,<span class="keyword">int</span> io0,<span class="keyword">int</span> io1,<span class="keyword">int</span> io2,</span></span></div><div class="line">                      <span class="keyword">int</span> io4,<span class="keyword">int</span> io5,<span class="keyword">int</span> io12,<span class="keyword">int</span> io13,</div><div class="line">                      <span class="keyword">int</span> io14,<span class="keyword">int</span> io15,RGBBean rgb)&#123;</div><div class="line">        <span class="keyword">this</span>.freq=freq;</div><div class="line">        <span class="keyword">this</span>.io0=io0;</div><div class="line">        <span class="keyword">this</span>.io1=io1;</div><div class="line">        <span class="keyword">this</span>.io2=io2;</div><div class="line">        <span class="keyword">this</span>.io4=io4;</div><div class="line">        <span class="keyword">this</span>.io5=io5;</div><div class="line">        <span class="keyword">this</span>.io12=io12;</div><div class="line">        <span class="keyword">this</span>.io13=io13;</div><div class="line">        <span class="keyword">this</span>.io14=io14;</div><div class="line">        <span class="keyword">this</span>.io15=io15;</div><div class="line">        <span class="keyword">this</span>.rgb=rgb;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadingNet</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        dao.loadingNet();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postingNet</span><span class="params">(LightModel model)</span> </span>&#123;</div><div class="line">        dao.postingNet(model);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getFreq</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> freq;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFreq</span><span class="params">(<span class="keyword">int</span> freq)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.freq = freq;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo0</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io0;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo0</span><span class="params">(<span class="keyword">int</span> io0)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io0 = io0;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo1</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io1;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo1</span><span class="params">(<span class="keyword">int</span> io1)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io1 = io1;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo2</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io2;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo2</span><span class="params">(<span class="keyword">int</span> io2)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io2 = io2;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo4</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io4;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo4</span><span class="params">(<span class="keyword">int</span> io4)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io4 = io4;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo5</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io5;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo5</span><span class="params">(<span class="keyword">int</span> io5)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io5 = io5;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo12</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io12;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo12</span><span class="params">(<span class="keyword">int</span> io12)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io12 = io12;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo13</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io13;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo13</span><span class="params">(<span class="keyword">int</span> io13)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io13 = io13;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo14</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io14;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo14</span><span class="params">(<span class="keyword">int</span> io14)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io14 = io14;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIo15</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> io15;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIo15</span><span class="params">(<span class="keyword">int</span> io15)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.io15 = io15;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> RGBBean <span class="title">getRgb</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> rgb;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRgb</span><span class="params">(RGBBean rgb)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.rgb = rgb;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然不需要数据库，不过数据访问对象习惯性用来操作数据，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">package</span> cn.kevinwu.esp8266_controller.dao;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Handler;</div><div class="line"><span class="keyword">import</span> android.os.Looper;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.Headers;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBus;</div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.api.Esp8266API;</div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.event.E;</div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.event.EventModel;</div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.model.LightModel;</div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.netutil.MyNet;</div><div class="line"><span class="keyword">import</span> cn.kevinwu.esp8266_controller.netutil.callback.StringCallback;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line"> * Created by KevinWu on 16-5-29.</div><div class="line"></div><div class="line"> * KevinWu.cn</div><div class="line"></div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightDAO</span> <span class="keyword">implements</span> <span class="title">IDAO</span>&lt;<span class="title">LightModel</span>&gt;</span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">"LightDAO"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadingNet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Handler handler=<span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line">        MyNet.get(Esp8266API.Light_Url)</div><div class="line">        .enqueue(<span class="keyword">new</span> StringCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result, <span class="keyword">int</span> responseCode, Headers headers)</span> </span>&#123;</div><div class="line">                Log.d(TAG,<span class="string">"responseCode is "</span>+responseCode);</div><div class="line">                Log.d(TAG,<span class="string">"result is "</span>+ result);</div><div class="line">                    handler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            EventBus.getDefault().post(<span class="keyword">new</span> EventModel&lt;Void&gt;(E.GET_LIGHT_STATUS_SUCCESS));</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(String error)</span> </span>&#123;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postingNet</span><span class="params">(LightModel model)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Handler handler=<span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line">        MyNet.postJson(Esp8266API.Light_Url)</div><div class="line">                .addJsonObject(model)</div><div class="line">                .enqueue(<span class="keyword">new</span> StringCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result, <span class="keyword">int</span> responseCode, Headers headers)</span> </span>&#123;</div><div class="line">                        Log.d(TAG,<span class="string">"response code is "</span>+responseCode);</div><div class="line">                        Log.d(TAG,<span class="string">"post back data is "</span>+result);</div><div class="line">                        handler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                EventBus.getDefault().post(<span class="keyword">new</span> EventModel&lt;Void&gt;(E.POST_LIGHT_STATUS_SUCCESS));</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(String error)</span> </span>&#123;</div><div class="line">                        handler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                EventBus.getDefault().post(<span class="keyword">new</span> EventModel&lt;Void&gt;(E.POST_LIGHT_STATUS_FAILURE));</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>网络访问用的是OKHTTP，经过了简单的封装，通信用的是EventBus，至于回调数据，其实是有json返回数据的，因为根据返回码的不同也能知道操作结果如何了，所以就直接取String了。</p>
<p>而对应Socket通信的url如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String Light_Url=<span class="string">"http://192.168.4.1/config?command=light"</span>;</div></pre></td></tr></table></figure>
<p>这种方案写出来的控制APP（没考虑UI）：</p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/36445265.jpg?imageMogr2/thumbnail/400x400" alt=""></p>
<p>到这里，这种方案已经很明确了，再次强调，不推荐这种方案，如果真的感兴趣可以查看完整项目源代码：</p>
<p><a href="https://github.com/KevinWu1993/ESP8266-Controller" target="_blank" rel="external">https://github.com/KevinWu1993/ESP8266-Controller</a></p>
<h2 id="基于ESPUSH云服务的的智能插座"><a href="#基于ESPUSH云服务的的智能插座" class="headerlink" title="基于ESPUSH云服务的的智能插座"></a>基于ESPUSH云服务的的智能插座</h2><p>ESPUSH是一个物联网云开发平台，而且是免费提供使用的，目前提供开发版硬件出售（不是打广告），挺适合初学者研究下的。</p>
<p>对于ESPUSH，这里就不做过多介绍了，有兴趣的可以自行去官网看看：</p>
<p><a href="https://espush.cn/" target="_blank" rel="external">https://espush.cn/</a></p>
<p>进入正题，在使用这个云开发平台前，你同样需要先动手连接好插座，然后到ESPUSH平台注册一个账号，然后添加一个硬件设备，这个流程没什么需要注意的，不细说。</p>
<p>因为这里只是用到GPIO的状态接口和控制接口，所以节选部分ESPUSH官方接口文档如下：</p>
<hr>
<h3 id="协议的整体描述"><a href="#协议的整体描述" class="headerlink" title="协议的整体描述"></a>协议的整体描述</h3><p>请求URL结构为：<strong><a href="http://接口域名/openapi/接口命令/?接口参数" target="_blank" rel="external">http://接口域名/openapi/接口命令/?接口参数</a></strong>，其中各字段取值如下：</p>
<ul>
<li>接口域名，域名，当前取值espush.cn 使用<a href="https://协议" target="_blank" rel="external">https://协议</a></li>
<li>openapi，固定取值，区分主站资源</li>
<li>接口命令，接口命令资源地址，详见下文</li>
<li>接口参数，使用HTTP GET方式传递的参数，包括通用参数、接口指定参数等<h3 id="通用参数"><a href="#通用参数" class="headerlink" title="通用参数"></a>通用参数</h3></li>
</ul>
<p>各接口URL都需要在URL中传递通用参数，参数列表简单摘要如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值类型</th>
<th>必填项</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>appid</td>
<td>整型</td>
<td>是</td>
<td>在<a href="https://espush.cn/webv2/apps/中进行管理" target="_blank" rel="external">https://espush.cn/webv2/apps/中进行管理</a></td>
</tr>
<tr>
<td>timestamp</td>
<td>整型</td>
<td>是</td>
<td>形如1434447718</td>
</tr>
<tr>
<td>sign</td>
<td>32位字符串</td>
<td>是</td>
<td>生成方式参考下文</td>
</tr>
</tbody>
</table>
<p>说明：</p>
<ul>
<li><strong>espush.cn的服务端API并不认证用户名与密码，只针对APPID与APPKEY，所以保护你的APPKEY，切勿泄露。</strong></li>
<li>请求请定义您自己的UserAgent，目前平台无限制，但为了做简要区分，请尽量不要使用任何带有robot字样的UserAgent。</li>
<li><p>目前接口的调用频次无限制，但针对部分请求，频繁调用可能会导致设备重置。</p>
<h3 id="通用返回结果"><a href="#通用返回结果" class="headerlink" title="通用返回结果"></a>通用返回结果</h3></li>
<li><p>接口使用非常简单的HTTP JSON API形式，成功的接口依据内容的不同返回内容也有不同，但都有共同的字段 msg，用于表明此次请求的返回说明，成功的请求使用200作为其返回码.</p>
</li>
<li>使用HTTP返回码，如 5XX代表服务端的错误，特别的，当与设备连接的网关服务器出错时，多返回502或504，并在msg中告知具体原因。4XX代表客户端的错误，通常401为sign取值错误，400是参数缺失，404是对应资源找不到。</li>
<li>服务端要求任何资源的请求末尾字符为 /，？后的GET参数不计在内，如不应该请求<a href="https://espush.cn/openapi/apps?timestamp=1466598336&amp;sign=a34e0360a05c739a08dd9ab404aec66b&amp;appid=1234而是应该发出https://espush.cn/openapi/apps/?timestamp=1466598336&amp;sign=a34e0360a05c739a08dd9ab404aec66b&amp;appid=1234这样的请求，区别在于" target="_blank" rel="external">https://espush.cn/openapi/apps?timestamp=1466598336&amp;sign=a34e0360a05c739a08dd9ab404aec66b&amp;appid=1234而是应该发出https://espush.cn/openapi/apps/?timestamp=1466598336&amp;sign=a34e0360a05c739a08dd9ab404aec66b&amp;appid=1234这样的请求，区别在于</a> apps 后是否有结束符 /，前者将会收到一个301的重定向返回。<h3 id="签名认证方式"><a href="#签名认证方式" class="headerlink" title="签名认证方式"></a>签名认证方式</h3></li>
</ul>
<p>内容签名sign的计算方法如下：</p>
<ul>
<li>提取请求的方法本身的小写字母表示，如 get, post等，记作字符串A</li>
<li>提取请求的其他参数（GET与POST参数均需要，COOKIES参数不计入）但不包括sign，并按Key-Value的形式并转换为小写字母表示（未做urlencode），再按Key的降序排列（排序时，Value未参与，只对Key的小写字母表示做字母表的降序排列），组成如下形式：<em>key3=v3&amp;key2=v4&amp;key1=v1</em>，此处记作字符串B</li>
<li>提取APPKEY，记字符串C</li>
<li>Sign的值为 S = lower(MD5(A+B+C))<br>如POST请求，现有如下信息：APPID为1234，APPKEY为25b28f0ffb9711e4a96d446d579b49a1，无其他额外的请求参数，则只有通用参数appid、timestamp与sign，则字符串S应为:<strong>gettimestamp=1433814203&amp;appid=123425b28f0ffb9711e4a96d446d579b49a1</strong>，对其进行MD5运算，取运算后的<strong>小写字母</strong>表示，即得到最终sign值:</li>
</ul>
<p><strong>9f0b613de12d5bb0451c556900a39559</strong></p>
<h3 id="接口详细定义"><a href="#接口详细定义" class="headerlink" title="接口详细定义"></a>接口详细定义</h3><h4 id="获取模块各GPIO口简要信息"><a href="#获取模块各GPIO口简要信息" class="headerlink" title="获取模块各GPIO口简要信息"></a>获取模块各GPIO口简要信息</h4><blockquote>
<p>接口地址：gpio_status/:chipid/</p>
<ul>
<li>功能说明，获取设备GPIO口电平状态，此API与下一接口，主要用于首页App，远控之用。</li>
<li>请求参数，无，使用通用参数</li>
<li>请求方法，GET</li>
<li>请求示例</li>
</ul>
<p>curl “<a href="https://espush.cn/openapi/gpio_status/8454703/?timestamp=1466642946&amp;sign=4d37cfc0233fc13b4858f0a35a48926a&amp;appid=1234" target="_blank" rel="external">https://espush.cn/openapi/gpio_status/8454703/?timestamp=1466642946&amp;sign=4d37cfc0233fc13b4858f0a35a48926a&amp;appid=1234</a>“</p>
<ul>
<li>返回示例</li>
</ul>
<p>{“result”: “\u0001\u0000\u0001\u0000\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000”}</p>
</blockquote>
<p>获取模块各GPIO口的状态</p>
<h4 id="简单设置模块GPIO电平接口"><a href="#简单设置模块GPIO电平接口" class="headerlink" title="简单设置模块GPIO电平接口"></a>简单设置模块GPIO电平接口</h4><blockquote>
<p>接口地址：set_gpio_edge/:chipid/:pin/:edge/</p>
<ul>
<li>功能说明，设置指定模块的GPIO口电平态，本处只限简单使用，输出高低电平，内部未做任何上拉使能、下拉使能处理，如需要输出pwm波形等，建议自行完成。</li>
<li>请求参数，无，使用通用参数；URL中，pin、edge等均为数字，其中edge仅限 0、1，分别代表 低水位电平、高水位电平</li>
<li>请求方法，POST</li>
<li>请求示例</li>
</ul>
<p>curl -X POST “<a href="https://espush.cn/openapi/set_gpio_edge/8454703/5/1/?timestamp=1466643023&amp;sign=58415f36b76cede2e85c7fabcec7538d&amp;appid=1234" target="_blank" rel="external">https://espush.cn/openapi/set_gpio_edge/8454703/5/1/?timestamp=1466643023&amp;sign=58415f36b76cede2e85c7fabcec7538d&amp;appid=1234</a>“</p>
<ul>
<li>返回示例</li>
</ul>
<p>{“result”: “\u0000”}</p>
</blockquote>
<hr>
<p>基于以上文档，第一步先定义好api的类，这里直接把完整代码放出来：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.kevinwu.esp8266_cloud_controller.api;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line"> * Created by KevinWu on 16-5-30.</div><div class="line"></div><div class="line"> * KevinWu.cn</div><div class="line"></div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EspushAPI</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_HOST = <span class="string">"https://espush.cn/openapi/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_APPS = URL_HOST + <span class="string">"apps/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_DEVICE_LIST = URL_HOST + <span class="string">"openapi/devices/list/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_IO_STATUS = URL_HOST + <span class="string">"gpio_status/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_REFRESH_DEVICE_ALIVE = URL_HOST + <span class="string">"manual_refresh/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_PUSH_MESSAGE = URL_HOST + <span class="string">"dev/push/message/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_SET_IO_EDGE = URL_HOST + <span class="string">"set_gpio_edge/"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这上面用到的只有<code>URL_HOST</code> 、 <code>URL_GET_IO_STATUS</code> 、 和<code>URL_SET_IO_EDGE</code>三个，其他的，额，其实当时想着以后如果深入研究就会用到的，嗯，深入研究。。。</p>
<p>下面看一下网络访问的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getStatus</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(SPUtil.get(MyApplication.AppContext, SPStaticKey.PLUS_SP_FILE,SPStaticKey.CHIPID,<span class="string">"null"</span>).equals(<span class="string">"null"</span>)</div><div class="line">                ||SPUtil.get(MyApplication.AppContext, SPStaticKey.PLUS_SP_FILE,SPStaticKey.APPID,<span class="string">"null"</span>).equals(<span class="string">"null"</span>))&#123;</div><div class="line">            setTogglebtnAndText();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            Setting.chipId=(String)SPUtil.get(MyApplication.AppContext, SPStaticKey.PLUS_SP_FILE,SPStaticKey.CHIPID,<span class="string">"null"</span>);</div><div class="line">            Setting.appid=(String)SPUtil.get(MyApplication.AppContext, SPStaticKey.PLUS_SP_FILE,SPStaticKey.APPID,<span class="string">"null"</span>);</div><div class="line">        &#125;</div><div class="line">        String url= EspushAPI.URL_GET_IO_STATUS+ Setting.chipId+<span class="string">"/?sign="</span></div><div class="line">                + SignUtil.getSign()+<span class="string">"&amp;timestamp="</span>+ TimeUtil.getTimestamp()+<span class="string">"&amp;appid="</span>+Setting.appid;</div><div class="line">        MyNet.get(url)</div><div class="line">                .enqueue(<span class="keyword">new</span> JsonCallback&lt;GPIOStatusRTBean&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="keyword">final</span> GPIOStatusRTBean entity, <span class="keyword">final</span> <span class="keyword">int</span> responseCode, Headers headers)</span> </span>&#123;</div><div class="line">                        Log.d(TAG,<span class="string">"网络访问成功"</span>);</div><div class="line">                        Log.d(TAG,<span class="string">"状态码为"</span>+responseCode);</div><div class="line">                        handle.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                <span class="keyword">if</span>(entity.getResult()!=<span class="keyword">null</span>&amp;&amp;responseCode==<span class="number">200</span>)&#123;</div><div class="line">                                    <span class="keyword">try</span> &#123;</div><div class="line">                                        String result=URLEncoder.encode (entity.getResult(), <span class="string">"UTF-8"</span> );</div><div class="line">                                        Log.d(TAG,result);</div><div class="line">                                        <span class="comment">//其他都低电平，io14高电平状态时，返回%00%00%00%00%00%00%00%00%00%00%01%00</span></div><div class="line">                                        <span class="comment">//因为分割后io14在下标11的位置，所以先直接写死</span></div><div class="line">                                        io14_Status=Integer.parseInt(result.split(<span class="string">"%"</span>)[<span class="number">11</span>]);</div><div class="line">                                        Log.d(TAG,<span class="string">"--"</span>+io14_Status);</div><div class="line">                                        setTogglebtnAndText();</div><div class="line">                                    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">                                        e.printStackTrace();</div><div class="line">                                        io14_Status=-<span class="number">1</span>;</div><div class="line">                                        setTogglebtnAndText();</div><div class="line">                                    &#125;</div><div class="line">                                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(responseCode==<span class="number">502</span>)&#123;</div><div class="line">                                    io14_Status=<span class="number">2</span>;</div><div class="line">                                    setTogglebtnAndText();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(String error)</span> </span>&#123;</div><div class="line">                        handle.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                io14_Status=<span class="number">2</span>;</div><div class="line">                                setTogglebtnAndText();</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(<span class="keyword">int</span> status)</span></span>&#123;</div><div class="line">        String url= EspushAPI.URL_SET_IO_EDGE+ Setting.chipId+<span class="string">"/14/"</span>+status+<span class="string">"/?sign="</span></div><div class="line">                + SignUtil.getSign()+<span class="string">"&amp;timestamp="</span>+ TimeUtil.getTimestamp()+<span class="string">"&amp;appid="</span>+Setting.appid;</div><div class="line">        MyNet.get(url)</div><div class="line">                .enqueue(<span class="keyword">new</span> JsonCallback&lt;GPIOStatusRTBean&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="keyword">final</span> GPIOStatusRTBean entity, <span class="keyword">int</span> responseCode, Headers headers)</span> </span>&#123;</div><div class="line">                        handle.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                getStatus();</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(String error)</span> </span>&#123;</div><div class="line">                        handle.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                io14_Status=<span class="number">2</span>;</div><div class="line">                                setTogglebtnAndText();</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>同第一种方案，网络访问之类的操作，用了封装后的OKHTTP，这里当时是省时间直接写上去了，也没有用EventBus之类的，也没考虑mvp的架构问题，不过如果抽离出来也花不了多少时间。。</p>
<p>对于芯片ID和APPID，当然不能暴露出来啦，所以用了sharedpreferences文件保存在手机本地，第一次使用的时候要求设置，因为没有做二维码扫描，而appkey可谓长的可怕，所以就直接写出来了，如果有需要参考这个项目自己写的童鞋记得改改<code>config</code>包下面的<code>Setting</code>类。</p>
<p>因为比较痴迷UI设计，所以简简单单的一个按钮的UI我也是思考了许久的，最终，也有别于第一种方案那种丑到炸的UI，而且引用了coolswitch实现了比较舒服的动画效果。</p>
<p>预览图如下：</p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/78446360.jpg?imageMogr2/thumbnail/400x400" alt=""></p>
<p><img src="http://7xvo7h.com1.z0.glb.clouddn.com/16-6-24/50208405.jpg?imageMogr2/thumbnail/400x400" alt=""></p>
<p>项目地址： <a href="https://github.com/KevinWu1993/ESP8266-Cloud-Controller" target="_blank" rel="external">https://github.com/KevinWu1993/ESP8266-Cloud-Controller</a></p>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#材料准备"><span class="toc-number">1.</span> <span class="toc-text">材料准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#硬件改造"><span class="toc-number">1.1.</span> <span class="toc-text">硬件改造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结一下改造步骤"><span class="toc-number">1.2.</span> <span class="toc-text">总结一下改造步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#本地局域网控制的智能插座"><span class="toc-number">2.</span> <span class="toc-text">本地局域网控制的智能插座</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于ESPUSH云服务的的智能插座"><span class="toc-number">3.</span> <span class="toc-text">基于ESPUSH云服务的的智能插座</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#协议的整体描述"><span class="toc-number">3.1.</span> <span class="toc-text">协议的整体描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通用参数"><span class="toc-number">3.2.</span> <span class="toc-text">通用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通用返回结果"><span class="toc-number">3.3.</span> <span class="toc-text">通用返回结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#签名认证方式"><span class="toc-number">3.4.</span> <span class="toc-text">签名认证方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接口详细定义"><span class="toc-number">3.5.</span> <span class="toc-text">接口详细定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取模块各GPIO口简要信息"><span class="toc-number">3.5.1.</span> <span class="toc-text">获取模块各GPIO口简要信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简单设置模块GPIO电平接口"><span class="toc-number">3.5.2.</span> <span class="toc-text">简单设置模块GPIO电平接口</span></a></li></ol></li></ol></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2018 | Powered by KevinWu&nbsp
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});

  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");

      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js"></script>


</body>
</html>
